<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Intercept Fetch Test</title>
    <link rel="stylesheet" href="https://unpkg.com/trelliscopejs-lib@0.7.16/dist/assets/index.css">
    <style>
        body { margin: 0; padding: 0; background: #000; color: #0f0; }
        #trelliscope_root { width: 100vw; height: calc(100vh - 400px); }
        #log {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: rgba(0,0,0,0.98); color: #0f0;
            padding: 15px; font-family: monospace; font-size: 10px;
            max-height: 400px; overflow: auto; z-index: 10000;
            border-top: 3px solid #0f0;
        }
        .success { color: #00ff00; font-weight: bold; }
        .error { color: #ff0000; font-weight: bold; }
    </style>
</head>
<body>
    <div id="trelliscope_root" class="trelliscope-not-spa"></div>
    <div id="log">═══ FETCH INTERCEPT TEST ═══<br></div>

    <script>
        const logDiv = document.getElementById('log');
        function log(msg, type = 'info') {
            console.log(msg);
            const className = type === 'success' ? 'success' : type === 'error' ? 'error' : '';
            logDiv.innerHTML += `<span class="${className}">${msg}</span><br>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        // Intercept fetch to see what the viewer is loading
        const originalFetch = window.fetch;
        window.fetch = async function(...args) {
            const url = args[0];
            log(`FETCH: ${url}`, 'success');

            const response = await originalFetch(...args);
            const clone = response.clone();

            try {
                const data = await clone.json();
                if (url.includes('displayInfo')) {
                    log('DISPLAYINFO LOADED:', 'success');
                    log('  name: ' + data.name);
                    log('  n: ' + data.n);
                    log('  height: ' + data.height);
                    log('  width: ' + data.width);
                    log('  panelInterface: ' + JSON.stringify(data.panelInterface));
                    log('  state.layout.viewtype: ' + data.state?.layout?.viewtype);
                    log('  Has cogInfo: ' + (!!data.cogInfo));
                    log('  Has cogDistns: ' + (!!data.cogDistns));
                }
                if (url.includes('metaData')) {
                    log('METADATA LOADED:', 'success');
                    log('  rows: ' + data.length);
                    if (data.length > 0) {
                        log('  first panel: ' + data[0].panel);
                    }
                }
            } catch (e) {
                // Not JSON
            }

            return response;
        };

        log('✓ Fetch interceptor active\n');
    </script>

    <script type="module">
        log('Loading viewer...');
        const module = await import('https://unpkg.com/trelliscopejs-lib@0.7.16/dist/assets/index.js');

        log('Module loaded');
        log('Exports: ' + Object.keys(module).join(', '));

        const initFunc = window.trelliscopeApp || module.trelliscopeApp;

        if (typeof initFunc === 'function') {
            log('Initializing...\n');
            initFunc('trelliscope_root', './config.json');
        } else {
            log('ERROR: trelliscopeApp not found', 'error');
        }

        setTimeout(() => {
            log('\n═══ 5 SECOND CHECK ═══');
            const viewerDiv = document.getElementById('trelliscope_root');
            const text = viewerDiv ? viewerDiv.textContent : '';

            if (text.match(/\d+\s*-\s*\d+\s+of\s+3/)) {
                log('✓ Shows "1 - 3 of 3"', 'success');
            }

            const imgs = viewerDiv ? viewerDiv.querySelectorAll('img') : [];
            log(`Images in DOM: ${imgs.length}`);

            if (imgs.length === 0) {
                log('\nDebugging info:', 'error');
                log('Check if all fetch calls succeeded above');
                log('Check if viewtype is "grid"');
                log('Check if panelInterface is correct');
            }
        }, 5000);
    </script>
</body>
</html>
