<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>ViewType Fix Test - CRITICAL</title>
    <link rel="stylesheet" href="https://unpkg.com/trelliscopejs-lib@0.7.16/dist/assets/index.css">
    <style>
        body { margin: 0; padding: 0; background: #1a1a1a; color: #00ff00; }
        #trelliscope_root { width: 100vw; height: calc(100vh - 200px); }
        #log {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: rgba(0,0,0,0.95); color: #00ff00;
            padding: 15px; font-family: monospace; font-size: 11px;
            max-height: 200px; overflow: auto; z-index: 10000;
            border-top: 3px solid #00ff00;
        }
        .success { color: #00ff00; font-weight: bold; }
        .error { color: #ff0000; font-weight: bold; }
        .info { color: #00aaff; }
    </style>
</head>
<body>
    <div id="trelliscope_root" class="trelliscope-not-spa"></div>
    <div id="log">‚ïê‚ïê‚ïê VIEWTYPE: GRID FIX TEST ‚ïê‚ïê‚ïê<br></div>

    <!-- Load metaData.js -->
    <script src="./displays/minimal_manual/metaData.js"></script>

    <script>
        const logDiv = document.getElementById('log');
        function log(msg, type = 'info') {
            const className = type;
            console.log(msg);
            logDiv.innerHTML += `<span class="${className}">${msg}</span><br>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        log('‚úì metaData loaded: ' + window.metaData.length + ' panels', 'success');

        // Intercept Image creation to track if viewer tries to create images
        let imageCount = 0;
        const OriginalImage = window.Image;
        window.Image = function() {
            const img = new OriginalImage();
            const id = imageCount++;

            const originalSetSrc = Object.getOwnPropertyDescriptor(HTMLImageElement.prototype, 'src').set;
            Object.defineProperty(img, 'src', {
                set: function(value) {
                    log(`[IMG ${id}] Creating image with src: ${value.substring(0, 70)}...`, 'success');
                    originalSetSrc.call(this, value);
                },
                get: function() {
                    return this.getAttribute('src');
                }
            });

            img.addEventListener('load', function() {
                log(`  ‚úì‚úì‚úì [IMG ${id}] LOADED! ${this.naturalWidth}x${this.naturalHeight}`, 'success');
            });
            img.addEventListener('error', function() {
                log(`  ‚úó‚úó‚úó [IMG ${id}] FAILED TO LOAD`, 'error');
            });

            return img;
        };

        log('‚úì Image interceptor active', 'info');
    </script>

    <script type="module">
        log('\n1. Loading viewer module...', 'info');
        const module = await import('https://esm.sh/trelliscopejs-lib@0.7.16?bundle');
        const initFunc = window.trelliscopeApp || module.trelliscopeApp;

        log('2. Initializing with config.jsonp...', 'info');
        initFunc('trelliscope_root', './config.jsonp');

        // Check after 3 seconds
        setTimeout(() => {
            log('\n‚ïê‚ïê‚ïê 3 SECOND CHECK ‚ïê‚ïê‚ïê', 'info');

            const viewerDiv = document.getElementById('trelliscope_root');
            const text = viewerDiv ? viewerDiv.textContent : '';

            // Check for panel count
            if (text.match(/\d+\s*-\s*\d+\s+of\s+3/)) {
                log('‚úì Shows panel count (e.g., "1 - 3 of 3")', 'success');
            } else {
                log('‚úó No panel count found', 'error');
            }

            // Check for "No Image" text (should NOT be present in grid mode)
            if (text.includes('No Image')) {
                log('‚úó‚úó‚úó STILL SHOWS "No Image" - Fix did not work!', 'error');
            } else {
                log('‚úì No "No Image" text found (good!)', 'success');
            }

            // Check for img elements
            const imgs = viewerDiv ? viewerDiv.querySelectorAll('img') : [];
            log(`Images in DOM: ${imgs.length}`, imgs.length > 0 ? 'success' : 'error');

            if (imgs.length > 0) {
                log('\nüéâüéâüéâ SUCCESS! IMAGES ARE RENDERING! üéâüéâüéâ', 'success');
                log('viewtype: "grid" was the missing field!', 'success');

                // Log image details
                imgs.forEach((img, i) => {
                    log(`  Image ${i}: src="${img.src}"`, 'info');
                });
            } else if (imageCount > 0) {
                log('\n‚ö† Image() constructor was called but no images in DOM', 'error');
                log('  Images may still be loading...', 'info');
            } else {
                log('\n‚úó Still no images created', 'error');
                log('  Image() constructor never called', 'error');
                log('  Need to investigate further...', 'error');
            }
        }, 3000);

        // Final check after 6 seconds (images might take time to load)
        setTimeout(() => {
            log('\n‚ïê‚ïê‚ïê 6 SECOND FINAL CHECK ‚ïê‚ïê‚ïê', 'info');

            const viewerDiv = document.getElementById('trelliscope_root');
            const imgs = viewerDiv ? viewerDiv.querySelectorAll('img') : [];

            log(`Final image count: ${imgs.length}`, imgs.length > 0 ? 'success' : 'error');

            if (imgs.length > 0) {
                // Check which images actually loaded
                let loadedCount = 0;
                imgs.forEach((img, i) => {
                    if (img.complete && img.naturalHeight > 0) {
                        loadedCount++;
                        log(`  ‚úì Image ${i} loaded: ${img.naturalWidth}x${img.naturalHeight}`, 'success');
                    } else {
                        log(`  ‚úó Image ${i} failed or still loading`, 'error');
                    }
                });

                log(`\n${loadedCount}/${imgs.length} images loaded successfully`, loadedCount > 0 ? 'success' : 'error');
            }
        }, 6000);
    </script>
</body>
</html>
