<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Inline Config Test - FINAL ATTEMPT</title>
    <link rel="stylesheet" href="https://unpkg.com/trelliscopejs-lib@0.7.16/dist/assets/index.css">
    <style>
        body { margin: 0; padding: 0; background: #000; color: #0f0; }
        #trelliscope_root { width: 100vw; height: calc(100vh - 300px); }
        #log {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: rgba(0,0,0,0.98); color: #0f0;
            padding: 15px; font-family: monospace; font-size: 11px;
            max-height: 300px; overflow: auto; z-index: 10000;
            border-top: 3px solid #0f0;
        }
        .success { color: #00ff00; font-weight: bold; }
        .error { color: #ff0000; font-weight: bold; }
    </style>
</head>
<body>
    <div id="trelliscope_root" class="trelliscope-not-spa"></div>
    <div id="log">‚ïê‚ïê‚ïê INLINE CONFIG TEST ‚ïê‚ïê‚ïê<br></div>

    <script>
        // INLINE metaData
        window.metaData = [
          {"id": 0, "value": 0, "category": "A", "panel": "panels/0.png"},
          {"id": 1, "value": 10, "category": "B", "panel": "panels/1.png"},
          {"id": 2, "value": 20, "category": "C", "panel": "panels/2.png"}
        ];

        // INLINE displayInfo config - EXACT structure from our fixed displayInfo.jsonp
        const displayConfig = {
          "name": "minimal_manual",
          "description": "Minimal manual example",
          "keysig": "manual123",
          "tags": [],
          "keycols": [],
          "metas": [
            {
              "varname": "id",
              "label": "ID",
              "type": "number",
              "digits": 0,
              "locale": false,
              "log": false,
              "tags": [],
              "filterable": true,
              "sortable": true
            },
            {
              "varname": "value",
              "label": "Value",
              "type": "number",
              "digits": 0,
              "locale": false,
              "log": false,
              "tags": [],
              "filterable": true,
              "sortable": true
            },
            {
              "varname": "category",
              "label": "Category",
              "type": "factor",
              "levels": ["A", "B", "C"],
              "tags": [],
              "filterable": true,
              "sortable": true
            }
          ],
          "inputs": null,
          "state": {
            "layout": {
              "type": "layout",
              "ncol": 3,
              "page": 1,
              "viewtype": "grid",  // KEY FIX!
              "sidebarActive": false
            },
            "labels": {
              "type": "labels",
              "varnames": []
            },
            "sort": [],
            "filter": [],
            "filterView": []
          },
          "views": [],
          "primarypanel": "panel",
          "thumbnailurl": "panels/0.png",
          "order": 0
        };
    </script>

    <script>
        const logDiv = document.getElementById('log');
        function log(msg, type = 'info') {
            console.log(msg);
            const className = type === 'success' ? 'success' : type === 'error' ? 'error' : '';
            logDiv.innerHTML += `<span class="${className}">${msg}</span><br>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        log('‚úì Inline metaData: ' + window.metaData.length + ' items');
        log('‚úì Inline displayConfig with viewtype: ' + displayConfig.state.layout.viewtype);

        // Intercept Image creation
        let imageCount = 0;
        const OriginalImage = window.Image;
        window.Image = function() {
            const img = new OriginalImage();
            const id = imageCount++;

            const originalSetSrc = Object.getOwnPropertyDescriptor(HTMLImageElement.prototype, 'src').set;
            Object.defineProperty(img, 'src', {
                set: function(value) {
                    log(`[IMG ${id}] src: ${value.substring(0, 60)}...`, 'success');
                    originalSetSrc.call(this, value);
                },
                get: function() {
                    return this.getAttribute('src');
                }
            });

            img.addEventListener('load', function() {
                log(`  ‚úì‚úì‚úì [IMG ${id}] LOADED ${this.naturalWidth}x${this.naturalHeight}`, 'success');
            });
            img.addEventListener('error', function() {
                log(`  ‚úó‚úó‚úó [IMG ${id}] FAILED`, 'error');
            });

            return img;
        };

        log('‚úì Image interceptor ready\n');
    </script>

    <script type="module">
        log('Loading viewer module...');
        const module = await import('https://esm.sh/trelliscopejs-lib@0.7.16?bundle');
        const initFunc = window.trelliscopeApp || module.trelliscopeApp;

        log('Trying to pass displayConfig object directly...\n');

        // Try passing config object instead of file path
        initFunc('trelliscope_root', displayConfig);

        setTimeout(() => {
            log('‚ïê‚ïê‚ïê 5 SECOND CHECK ‚ïê‚ïê‚ïê');

            const viewerDiv = document.getElementById('trelliscope_root');
            const text = viewerDiv ? viewerDiv.textContent : '';

            if (text.match(/\d+\s*-\s*\d+\s+of\s+3/)) {
                log('‚úì Shows "1 - 3 of 3"', 'success');
            } else if (text.includes('0 of 0')) {
                log('‚úó Shows "0 of 0"', 'error');
            }

            if (text.includes('No Image')) {
                log('‚úó Still shows "No Image" (table mode)', 'error');
            }

            const imgs = viewerDiv ? viewerDiv.querySelectorAll('img') : [];
            log(`Images in DOM: ${imgs.length}`, imgs.length > 0 ? 'success' : 'error');

            if (imgs.length > 0) {
                log('\nüéâüéâüéâ SUCCESS! IMAGES RENDERING! üéâüéâüéâ', 'success');
                log('SOLUTION: Inline config with viewtype: grid', 'success');
            } else if (imageCount > 0) {
                log('\n‚ö† Image() called but no DOM elements', 'error');
            } else {
                log('\n‚úó No images created - checking if init failed', 'error');
                log('Check if viewer accepted inline config object', 'error');
            }
        }, 5000);
    </script>
</body>
</html>
