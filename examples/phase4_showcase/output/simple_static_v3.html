<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Simple Static v3 - Using config.json</title>
    <link rel="stylesheet" href="https://unpkg.com/trelliscopejs-lib@0.7.16/dist/assets/index.css">
    <style>
        body { margin: 0; padding: 0; background: #1a1a1a; color: #0f0; }
        #trelliscope_root { width: 100vw; height: calc(100vh - 400px); }
        #log {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: rgba(0,0,0,0.98); color: #0f0;
            padding: 15px; font-family: monospace; font-size: 11px;
            max-height: 400px; overflow: auto; z-index: 10000;
            border-top: 3px solid #0f0;
        }
        .success { color: #00ff00; font-weight: bold; }
        .error { color: #ff0000; font-weight: bold; }
        .info { color: #00bfff; }
    </style>
</head>
<body>
    <div id="trelliscope_root" class="trelliscope-not-spa"></div>
    <div id="log">═══ APPROACH 2 v3: USING config.json ═══<br></div>

    <script>
        const logDiv = document.getElementById('log');
        function log(msg, type = 'info') {
            console.log(msg);
            const className = type === 'success' ? 'success' : type === 'error' ? 'error' : 'info';
            logDiv.innerHTML += `<span class="${className}">${msg}</span><br>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        // Intercept fetch
        const originalFetch = window.fetch;
        window.fetch = async function(...args) {
            const url = args[0];
            log(`FETCH: ${url}`, 'info');
            const response = await originalFetch(...args);

            if (url.includes('config.json')) {
                const clone = response.clone();
                const data = await clone.json();
                log('✓ Config loaded:', 'success');
                log('  Display base: ' + data.display_base);
            } else if (url.includes('displayList')) {
                const clone = response.clone();
                const data = await clone.json();
                log('✓ Display list loaded: ' + data.length + ' displays', 'success');
                data.forEach(d => log('  - ' + d.name + ': ' + d.description));
            } else if (url.includes('displayInfo')) {
                const clone = response.clone();
                const data = await clone.json();
                log('✓ DisplayInfo loaded:', 'success');
                log('  Display: ' + data.name);
                log('  Panels: ' + data.n);
                const panelMeta = data.metas.find(m => m.type === 'panel');
                if (panelMeta) {
                    log('  Panel source: ' + JSON.stringify(panelMeta.source));
                } else {
                    log('  ERROR: No panel meta found!', 'error');
                }
            } else if (url.includes('metadata.csv')) {
                const clone = response.clone();
                const text = await clone.text();
                log('✓ Metadata loaded: ' + text.split('\\n').length + ' lines', 'success');
            } else if (url.includes('.png')) {
                log('✓ Panel image: ' + url.split('/').pop(), 'success');
            }

            return response;
        };

        // Intercept Image constructor
        const OriginalImage = window.Image;
        let imageCount = 0;
        window.Image = function() {
            imageCount++;
            const img = new OriginalImage();
            const originalSrcSet = Object.getOwnPropertyDescriptor(HTMLImageElement.prototype, 'src').set;
            Object.defineProperty(img, 'src', {
                set: function(value) {
                    log(`IMAGE #${imageCount} src: ${value}`, 'info');
                    originalSrcSet.call(this, value);
                },
                get: function() {
                    return this.getAttribute('src');
                }
            });
            return img;
        };

        log('✓ Interceptors active\\n');
    </script>

    <script type="module">
        log('Loading viewer module...');
        const module = await import('https://unpkg.com/trelliscopejs-lib@0.7.16/dist/assets/index.js');

        log('✓ Module loaded');
        const initFunc = window.trelliscopeApp || module.trelliscopeApp;

        if (typeof initFunc === 'function') {
            log('Initializing with ./config.json...\\n');

            // Initialize with config.json (same as test_html_panels.html)
            initFunc('trelliscope_root', './config.json');

            setTimeout(() => {
                log('\\n═══ 5 SEC CHECK ═══');
                const viewerDiv = document.getElementById('trelliscope_root');
                const imgs = viewerDiv ? viewerDiv.querySelectorAll('img') : [];
                log(`Images in DOM: ${imgs.length}`, imgs.length > 0 ? 'success' : 'error');
                log(`Total Image() calls: ${imageCount}`);

                if (imgs.length > 0) {
                    imgs.forEach((img, i) => {
                        log(`  img[${i}].src = ${img.src}`, img.complete ? 'success' : 'error');
                    });
                } else {
                    log('\\nNo images found. Check:', 'error');
                    log('1. Is simple_static selected in dropdown?');
                    log('2. Does displayInfo.json have correct panel source?');
                }
            }, 5000);
        } else {
            log('ERROR: trelliscopeApp not found', 'error');
        }
    </script>
</body>
</html>
