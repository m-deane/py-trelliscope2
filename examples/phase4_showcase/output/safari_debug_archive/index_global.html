<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Trelliscope - Global API</title>
    <link rel="stylesheet" href="https://unpkg.com/trelliscopejs-lib@0.7.16/dist/assets/index.css">
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }
        #trelliscope-root {
            width: 100vw;
            height: 100vh;
        }
        #debug {
            position: fixed;
            top: 10px;
            right: 10px;
            background: black;
            color: lime;
            padding: 10px;
            font-family: monospace;
            font-size: 11px;
            max-width: 400px;
            max-height: 80vh;
            overflow: auto;
            z-index: 10000;
            border: 2px solid lime;
        }
    </style>
</head>
<body>
    <div id="debug">Loading...</div>
    <div id="trelliscope-root"></div>

    <!-- Load library with script tag - should expose globals -->
    <script src="./trelliscope-lib.min.js"></script>

    <script>
        const debug = document.getElementById('debug');
        function log(msg) {
            console.log(msg);
            debug.innerHTML += msg + '<br>';
        }

        // Wait a bit for library to load
        setTimeout(function() {
            try {
                log('1. Checking window for Trelliscope...');

                // Find all Trelliscope-related globals
                const trelliscopeGlobals = Object.keys(window).filter(function(key) {
                    return key.toLowerCase().indexOf('trell') !== -1;
                });

                log('2. Trelliscope globals found: ' + trelliscopeGlobals.join(', '));

                // Check common global names
                log('3. window.Trelliscope: ' + typeof window.Trelliscope);
                log('4. window.TrelliscopeApp: ' + typeof window.TrelliscopeApp);
                log('5. window.trelliscopeApp: ' + typeof window.trelliscopeApp);
                log('6. window.trelliscope: ' + typeof window.trelliscope);

                // Try to find the init function
                let initFunc = window.trelliscopeApp || window.Trelliscope || window.TrelliscopeApp;

                if (initFunc && typeof initFunc === 'function') {
                    log('7. Found init function! Type: ' + typeof initFunc);
                    log('8. Function signature: ' + initFunc.toString().substring(0, 200));

                    log('9. Calling with (id, path) pattern from R package...');

                    // R package pattern: trelliscopeApp(id, config_path)
                    initFunc('trelliscope-root', './basic_viewer_demo/displayInfo.json');

                    setTimeout(function() {
                        const root = document.getElementById('trelliscope-root');
                        if (root.children.length > 0) {
                            log('SUCCESS! Viewer rendered!');
                            debug.style.background = 'green';
                            setTimeout(function() { debug.style.display = 'none'; }, 3000);
                        } else {
                            log('10. Pattern (id, path) failed. Trying to load JSON first...');

                            // Load JSON and try again
                            fetch('./basic_viewer_demo/displayInfo.json')
                                .then(function(r) { return r.json(); })
                                .then(function(data) {
                                    log('11. JSON loaded. Trying with data object...');
                                    initFunc('trelliscope-root', data);

                                    setTimeout(function() {
                                        if (root.children.length > 0) {
                                            log('SUCCESS with data object!');
                                            debug.style.background = 'green';
                                        } else {
                                            log('ERROR: Still nothing rendered');
                                            debug.style.background = 'red';
                                        }
                                    }, 1000);
                                });
                        }
                    }, 1000);

                } else if (initFunc && typeof initFunc === 'object') {
                    log('7. Found object. Keys: ' + Object.keys(initFunc).join(', '));

                    if (initFunc.createApp) {
                        log('8. Has createApp method!');
                        initFunc.createApp({
                            id: 'trelliscope-root',
                            displayListPath: './basic_viewer_demo/displayInfo.json'
                        });
                    }
                } else {
                    log('ERROR: No init function found!');
                    log('All window keys (first 50): ' + Object.keys(window).slice(0, 50).join(', '));
                    debug.style.background = 'red';
                }

            } catch (error) {
                log('ERROR: ' + error.message);
                log('Stack: ' + error.stack);
                debug.style.background = 'red';
            }
        }, 1000);
    </script>
</body>
</html>
