<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Cache Bust Test - Refinery</title>
    <link rel="stylesheet" href="./viewer/assets/index.css?v=<?php echo time(); ?>">
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }
        #trelliscope-root {
            width: 100vw;
            height: 100vh;
        }
        #debug {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 10px;
            font-family: monospace;
            font-size: 12px;
            max-width: 400px;
            z-index: 10000;
        }
        .pass { color: #00ff00; }
        .fail { color: #ff0000; }
    </style>
</head>
<body>
    <div id="trelliscope-root" class="trelliscope-not-spa"></div>
    <div id="debug">Loading...</div>

    <script type="module">
        const debug = document.getElementById('debug');
        function log(msg, status = 'info') {
            const span = document.createElement('div');
            span.className = status;
            span.textContent = msg;
            debug.appendChild(span);
        }

        try {
            // Load with timestamp to bust cache
            const timestamp = new Date().getTime();
            log(`Loading viewer.js?v=${timestamp}`);

            const module = await import(`./viewer/assets/index.js?v=${timestamp}`);
            log('✓ Viewer loaded', 'pass');

            // Test the getLabelFromFactor equivalent
            const response = await fetch('./displays/refinery_plotly/displayInfo.json');
            const data = await response.json();
            log('✓ DisplayInfo loaded', 'pass');

            const countryMeta = data.metas.find(m => m.varname === 'country');
            log(`Country levels: ${countryMeta.levels.slice(0, 3).join(', ')}...`, 'pass');

            // Test data
            const firstCountry = data.cogData[0].country;
            log(`First country value: ${firstCountry} (${typeof firstCountry})`,
                typeof firstCountry === 'number' ? 'pass' : 'fail');

            if (typeof firstCountry === 'number' && countryMeta.levels) {
                const label = countryMeta.levels[firstCountry];
                log(`Lookup: levels[${firstCountry}] = "${label}"`,
                    label ? 'pass' : 'fail');
            }

            const initFunc = window.trelliscopeApp || module.trelliscopeApp;

            if (typeof initFunc === 'function') {
                log('✓ Initializing viewer...', 'pass');
                initFunc('trelliscope-root', './config.json');
            } else {
                log('✗ trelliscopeApp not found!', 'fail');
            }
        } catch (error) {
            log(`✗ Error: ${error.message}`, 'fail');
        }
    </script>
</body>
</html>
