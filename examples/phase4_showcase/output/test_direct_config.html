<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Trelliscope - Direct Config Test</title>
    <link rel="stylesheet" href="https://unpkg.com/trelliscopejs-lib@0.7.16/dist/assets/index.css">
    <style>
        body { margin: 0; padding: 0; }
        #trelliscope-root { width: 100vw; height: 100vh; }
        #status {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background: black;
            color: lime;
            padding: 10px;
            font-family: monospace;
            font-size: 12px;
            max-width: 500px;
            z-index: 10000;
            border: 2px solid lime;
        }
    </style>
</head>
<body>
    <div id="status">Testing...</div>
    <div id="trelliscope-root" class="trelliscope-not-spa"></div>

    <script type="module">
        const status = document.getElementById('status');
        function log(msg) {
            console.log(msg);
            status.innerHTML += '<br>' + msg;
        }

        log('1. Loading config...');
        const cacheBust = Date.now();
        const resp = await fetch(`./basic_viewer_demo/displayInfo.json?v=${cacheBust}`, {
            cache: 'no-store'
        });
        const config = await resp.json();

        log(`2. Config loaded with ${config.metaData.length} rows`);

        // Try different config structures
        const configs = {
            // Test 1: Pass path to directory
            test1: {
                desc: 'Path to directory',
                value: './basic_viewer_demo'
            },
            // Test 2: Pass config object directly
            test2: {
                desc: 'Config object',
                value: config
            },
            // Test 3: Config with id property
            test3: {
                desc: 'Config with id',
                value: {
                    ...config,
                    id: 'trelliscope-root'
                }
            },
            // Test 4: Wrapped in display property
            test4: {
                desc: 'Wrapped in display',
                value: {
                    display: config
                }
            }
        };

        const module = await import('https://esm.sh/trelliscopejs-lib@0.7.16?bundle');
        const initFunc = window.trelliscopeApp || module.trelliscopeApp;

        log('3. Function signature check:');
        log(`   Name: ${initFunc.name}`);
        log(`   Length: ${initFunc.length} args`);

        // Try each config
        for (const [testName, test] of Object.entries(configs)) {
            log(`\n4. Testing: ${test.desc}`);

            // Clear root
            const root = document.getElementById('trelliscope-root');
            root.innerHTML = '';
            root.className = 'trelliscope-not-spa';

            try {
                const result = initFunc('trelliscope-root', test.value);
                log(`   Result: ${typeof result}`);

                await new Promise(resolve => setTimeout(resolve, 2000));

                const imgs = root.querySelectorAll('img');
                log(`   Images: ${imgs.length}`);

                if (imgs.length > 0) {
                    log(`   ✓✓✓ SUCCESS with ${test.desc}!`);
                    status.style.background = 'green';

                    imgs.forEach((img, i) => {
                        log(`     Panel ${i}: ${img.src.split('/').pop()}`);
                    });

                    break; // Stop on first success
                }
            } catch (err) {
                log(`   ✗ Error: ${err.message}`);
            }
        }

        setTimeout(() => {
            const finalCount = document.querySelectorAll('#trelliscope-root img').length;
            if (finalCount === 0) {
                log('\n❌ None of the configs worked');
                status.style.background = 'red';
            }
        }, 10000);
    </script>
</body>
</html>
