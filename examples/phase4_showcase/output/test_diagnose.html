<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Diagnostic Test</title>
    <link rel="stylesheet" href="https://unpkg.com/trelliscopejs-lib@0.7.16/dist/assets/index.css">
    <style>
        body { margin: 0; padding: 0; background: #000; color: #0f0; font-family: monospace; }
        #trelliscope_root { width: 100vw; height: calc(100vh - 400px); }
        #log {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: rgba(0,0,0,0.98); color: #0f0;
            padding: 15px; font-size: 11px;
            max-height: 400px; overflow: auto; z-index: 10000;
            border-top: 3px solid #0f0;
        }
    </style>
</head>
<body>
    <div id="trelliscope_root" class="trelliscope-not-spa"></div>
    <div id="log">═══ DIAGNOSTIC TEST ═══<br></div>

    <!-- Load metaData.js FIRST -->
    <script src="./displays/minimal_manual/metaData.js"></script>

    <script>
        const logDiv = document.getElementById('log');
        function log(msg) {
            console.log(msg);
            logDiv.innerHTML += msg + '<br>';
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        log('1. Checking window.metaData BEFORE viewer init:');
        log('   typeof window.metaData: ' + typeof window.metaData);
        if (typeof window.metaData !== 'undefined') {
            log('   window.metaData.length: ' + window.metaData.length);
            log('   First item: ' + JSON.stringify(window.metaData[0]));
        } else {
            log('   ✗✗✗ window.metaData is UNDEFINED!');
        }

        // Wrap the callback to see if it fires
        const originalLoadDisplayInfo = window.__loadDisplayInfo__trelliscope_root;
        window.__loadDisplayInfo__trelliscope_root = function(data) {
            log('\n2. __loadDisplayInfo__ callback fired!');
            log('   data.name: ' + data.name);
            log('   data.metas.length: ' + data.metas.length);
            log('   data.state.layout.viewtype: ' + data.state.layout.viewtype);
            log('   data.state.layout.ncol: ' + data.state.layout.ncol);
            log('   data.primarypanel: ' + data.primarypanel);

            if (originalLoadDisplayInfo) {
                return originalLoadDisplayInfo(data);
            }
        };
    </script>

    <script type="module">
        log('\n3. Loading viewer module...');
        const module = await import('https://esm.sh/trelliscopejs-lib@0.7.16?bundle');
        const initFunc = window.trelliscopeApp || module.trelliscopeApp;

        log('4. Checking window.metaData AFTER module load:');
        log('   typeof window.metaData: ' + typeof window.metaData);
        if (typeof window.metaData !== 'undefined') {
            log('   window.metaData.length: ' + window.metaData.length);
        }

        log('\n5. Initializing viewer with config.jsonp...');
        initFunc('trelliscope_root', './config.jsonp');

        setTimeout(() => {
            log('\n═══ 3 SECOND CHECK ═══');

            const viewerDiv = document.getElementById('trelliscope_root');
            const text = viewerDiv ? viewerDiv.textContent : '';

            log('Viewer text content (first 200 chars):');
            log('  ' + text.substring(0, 200));

            if (text.includes('0 of 0')) {
                log('\n✗✗✗ Shows "0 of 0" - viewer thinks there is no data');
                log('   This means the viewer is not reading window.metaData');
                log('   OR there is a mismatch in how data is referenced');
            } else if (text.match(/\d+\s*-\s*\d+\s+of\s+\d+/)) {
                log('\n✓✓✓ Shows panel count - viewer found the data!');
            }
        }, 3000);
    </script>
</body>
</html>
