<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Intercept All Requests</title>
    <link rel="stylesheet" href="https://unpkg.com/trelliscopejs-lib@0.7.16/dist/assets/index.css">
    <style>
        body { margin: 0; padding: 0; background: #000; color: #0f0; }
        #trelliscope-root { width: 100vw; height: 100vh; position: fixed; top: 0; left: 0; }
        #log {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: rgba(0,0,0,0.95); color: #0f0;
            padding: 15px; font-family: monospace; font-size: 11px;
            max-height: 300px; overflow: auto; z-index: 10000;
            border-top: 2px solid #0f0;
        }
    </style>
</head>
<body>
    <div id="trelliscope-root" class="trelliscope-not-spa"></div>
    <div id="log">═══ INTERCEPTING ALL REQUESTS ═══<br></div>

    <script src="./minimal_manual/metaData.js"></script>

    <script>
        const logDiv = document.getElementById('log');
        function log(msg) {
            console.log(msg);
            logDiv.innerHTML += msg + '<br>';
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        log('✓ metaData.js loaded, window.metaData = ' + (window.metaData ? window.metaData.length + ' rows' : 'MISSING'));

        // Intercept ALL fetch requests
        const fetchLog = [];
        const originalFetch = window.fetch;
        window.fetch = function(...args) {
            const url = typeof args[0] === 'string' ? args[0] : args[0].url;
            log('[FETCH] ' + url);
            fetchLog.push(url);
            return originalFetch.apply(this, args);
        };

        log('✓ Fetch interceptor active');
    </script>

    <script type="module">
        const module = await import('https://esm.sh/trelliscopejs-lib@0.7.16?bundle');
        const initFunc = window.trelliscopeApp || module.trelliscopeApp;

        log('Initializing viewer with: ./minimal_manual/displayInfo.json');
        const result = initFunc('trelliscope-root', './minimal_manual/displayInfo.json');

        setTimeout(() => {
            log('\n═══ AFTER 4 SECONDS ═══');
            log('Fetch requests made: ' + fetchLog.length);
            fetchLog.forEach((url, i) => {
                log('  ' + (i+1) + '. ' + url);
            });

            const text = document.body.textContent;
            if (text.includes('0 of 0')) {
                log('\n❌ Viewer shows "0 of 0" - NOT finding data');
                log('   window.metaData still exists: ' + !!window.metaData);
                log('   window.metaData length: ' + (window.metaData?.length || 'N/A'));
            } else if (text.includes('of 3')) {
                log('\n✓ Viewer found 3 panels!');
            }

            // Check what global variables exist
            const trellKeys = Object.keys(window).filter(k =>
                k.toLowerCase().includes('trell') ||
                k.toLowerCase().includes('meta') ||
                k.toLowerCase().includes('data')
            );
            log('\nRelevant global variables:');
            trellKeys.forEach(key => {
                const val = window[key];
                const type = typeof val;
                const info = Array.isArray(val) ? `array[${val.length}]` : type;
                log('  window.' + key + ' = ' + info);
            });
        }, 4000);
    </script>
</body>
</html>
