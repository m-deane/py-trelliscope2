<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Pure JSONP Mode</title>
    <link rel="stylesheet" href="https://unpkg.com/trelliscopejs-lib@0.7.16/dist/assets/index.css">
    <style>
        body { margin: 0; padding: 0; background: #000; color: #0f0; }
        #trelliscope_root { width: 100vw; height: calc(100vh - 200px); }
        #log {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: rgba(0,0,0,0.95); color: #0f0;
            padding: 15px; font-family: monospace; font-size: 10px;
            max-height: 200px; overflow: auto; z-index: 10000;
            border-top: 2px solid #0f0;
        }
    </style>
</head>
<body>
    <div id="trelliscope_root" class="trelliscope-not-spa"></div>
    <div id="log">‚ïê‚ïê‚ïê PURE JSONP MODE ‚ïê‚ïê‚ïê<br></div>

    <script>
        const logDiv = document.getElementById('log');
        function log(msg) {
            console.log(msg);
            logDiv.innerHTML += msg + '<br>';
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        // Intercept Image creation
        let imageCount = 0;
        const OriginalImage = window.Image;
        window.Image = function() {
            const img = new OriginalImage();
            const id = imageCount++;

            const originalSetSrc = Object.getOwnPropertyDescriptor(HTMLImageElement.prototype, 'src').set;
            Object.defineProperty(img, 'src', {
                set: function(value) {
                    log('[IMG ' + id + '] src = ' + value);
                    originalSetSrc.call(this, value);
                },
                get: function() {
                    return this.getAttribute('src');
                }
            });

            img.addEventListener('load', () => log('  ‚úì [IMG ' + id + '] loaded'));
            img.addEventListener('error', () => log('  ‚úó [IMG ' + id + '] failed'));

            return img;
        };

        log('‚úì Interceptor active');
    </script>

    <!-- Load JSONP files BEFORE initializing viewer -->
    <!-- These will call callbacks that viewer will register -->
    <script src="./config.jsonp"></script>
    <script src="./displays/displayList.jsonp"></script>
    <script src="./displays/minimal_manual/displayInfo.jsonp"></script>
    <script src="./displays/minimal_manual/metaData.js"></script>

    <script type="module">
        log('\n1. JSONP files loaded');
        log('   config callback exists: ' + (typeof window.__loadAppConfig__trelliscope_root));
        log('   displayList callback exists: ' + (typeof window.__loadDisplayList__trelliscope_root));
        log('   displayInfo callback exists: ' + (typeof window.__loadDisplayInfo__trelliscope_root));
        log('   window.metaData exists: ' + !!window.metaData);

        log('\n2. Loading viewer module...');
        const module = await import('https://esm.sh/trelliscopejs-lib@0.7.16?bundle');
        const initFunc = window.trelliscopeApp || module.trelliscopeApp;

        log('3. Initializing viewer in JSONP mode...');
        initFunc('trelliscope_root', './config.jsonp');

        setTimeout(() => {
            log('\n‚ïê‚ïê‚ïê AFTER 3 SECONDS ‚ïê‚ïê‚ïê');

            // Count actual text in viewer
            const viewerDiv = document.getElementById('trelliscope_root');
            const viewerText = viewerDiv ? viewerDiv.textContent : '';
            const match = viewerText.match(/(\d+)\s*-\s*(\d+)\s+of\s+(\d+)/);

            if (match) {
                log('‚úì Viewer shows: "' + match[0] + '"');
            } else if (viewerText.includes('0 of 0')) {
                log('‚úó Viewer shows: "0 of 0"');
            } else {
                log('? Unknown viewer state');
            }

            const imgs = document.querySelectorAll('#trelliscope_root img');
            log('Images in viewer: ' + imgs.length);

            if (imgs.length > 0) {
                log('\nüéâüéâüéâ SUCCESS! IMAGES RENDERING! üéâüéâüéâ');
                imgs.forEach((img, i) => {
                    log('  img[' + i + ']: ' + (img.src ? img.src.substring(img.src.lastIndexOf('/') + 1) : 'no src'));
                });
            } else {
                log('\n‚úó No images in viewer');
            }
        }, 3000);
    </script>
</body>
</html>
